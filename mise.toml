# =============================================================================
# Tools
# =============================================================================
[tools]
node = "lts"

# =============================================================================
# Development
# =============================================================================
[tasks.dev]
description = "Start development server"
run = "pnpm --filter @jant/core dev"

[tasks.build]
description = "Build all packages"
run = "pnpm --filter @jant/core build"

[tasks.lint]
description = "Run ESLint"
run = "pnpm --filter @jant/core lint"

[tasks.typecheck]
description = "Run TypeScript type checking"
run = "pnpm --filter @jant/core typecheck"

[tasks.format]
description = "Format code with Prettier"
run = "prettier --write ."

[tasks.format-check]
description = "Check code formatting"
run = "prettier --check ."

# =============================================================================
# Database (D1)
# =============================================================================
[tasks.db-generate]
alias = "generate"
description = "Generate Drizzle migrations"
run = "pnpm --filter @jant/core db:generate"

[tasks.db-migrate]
alias = "migrate"
description = "Run D1 migrations (local)"
run = "pnpm --filter @jant/core db:migrate:local"

[tasks.db-migrate-remote]
description = "Run D1 migrations (remote)"
run = "pnpm --filter @jant/core db:migrate:remote"

# =============================================================================
# i18n (Lingui)
# =============================================================================
[tasks.i18n]
description = "Extract and compile translations"
run = "pnpm --filter @jant/core i18n:build"

[tasks.i18n-extract]
alias = "extract"
description = "Extract messages from source"
run = "pnpm --filter @jant/core i18n:extract"

[tasks.i18n-compile]
alias = "compile"
description = "Compile PO files to JS"
run = "pnpm --filter @jant/core i18n:compile"

[tasks.translate]
description = "Translate all locales using AI (requires OPENAI_API_KEY)"
depends = ["translate-zh-Hans", "translate-zh-Hant"]

[tasks.translate-zh-Hans]
alias = "tz"
description = "Translate to Simplified Chinese"
run = """
npx lingui-po-translate \
  --srcFile=packages/core/src/i18n/locales/en.po \
  --srcLng=en \
  --srcFormat=po \
  --targetFile=packages/core/src/i18n/locales/zh-Hans.po \
  --targetLng=zh-Hans \
  --targetFormat=po \
  --service=openai \
  --serviceConfig="$OPENAI_API_KEY"
"""

[tasks.translate-zh-Hant]
alias = "tt"
description = "Translate to Traditional Chinese"
run = """
npx lingui-po-translate \
  --srcFile=packages/core/src/i18n/locales/en.po \
  --srcLng=en \
  --srcFormat=po \
  --targetFile=packages/core/src/i18n/locales/zh-Hant.po \
  --targetLng=zh-Hant \
  --targetFormat=po \
  --service=openai \
  --serviceConfig="$OPENAI_API_KEY" \
  --sourceOverride="zh-Hant:zh-Hans"
"""

# =============================================================================
# Deploy
# =============================================================================
[tasks.deploy]
description = "Deploy to Cloudflare Workers"
run = "pnpm --filter @jant/core deploy"

# =============================================================================
# Utilities
# =============================================================================
[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf packages/*/dist packages/*/.wrangler"

[tasks.nuke]
description = "Remove all node_modules and reinstall"
run = "rm -rf node_modules packages/*/node_modules && pnpm install"
