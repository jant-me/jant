# Jant - 设计决策记录

> 本文档记录了在规划阶段确认的设计决策

---

## 1. 技术验证

### 1.1 better-auth + D1 兼容性
- **状态**：✅ 待实现时验证
- **决策**：先假设可用，实现时如遇问题再调整

### 1.2 BaseCoat UI
- **状态**：✅ 已确认
- **结论**：基于 Tailwind 的无框架 UI 库，通过 class 使用（如 `btn`, `input`）

---

## 2. 数据模型（已确认）

### 2.1 media 表
- **决策**：media 可独立存在（先上传后使用），post_id 可选
- **存储**：R2（Cloudflare S3 兼容存储）

### 2.2 collections 表
- **决策**：
  - 不需要可见性控制（Collection 本身始终可见）
  - 帖子按时间倒序排列
  - 不需要封面图

### 2.3 post_collections 关联
- **决策**：一个帖子可以属于多个 Collection

### 2.4 settings 表
- **决策**：Key-Value 方案，key 命名与环境变量保持一致

### 2.5 redirects 表
- **决策**：支持外部 URL 重定向（to_path 可以是完整 URL）

---

## 3. 业务逻辑（已确认）

### 3.1 Thread 可见性
- **决策**：方案 C - 创建时复制 + 级联更新
- **理由**：查询性能好 + 符合「Thread 是一个整体」的语义

### 3.2 保留路径
- **决策**：列表完整，通过 `lib/constants.ts` 导出，支持配置

### 3.3 Onboarding 流程
- **决策**：
  - 通过 settings.ONBOARDING_STATUS 判断
  - Setup 页面收集：管理员账号、站点名称、站点语言
  - 存储配置不在 Setup 收集，放在 /dash/settings 配置

---

## 4. 存储与图片处理（已确认）

### 4.1 存储方案
- **决策**：
  - 存储配置通过环境变量（不存数据库）
  - Cloudflare 部署默认使用 R2
  - 未配置时上传报错，设置页面显示提示

### 4.2 图片处理
- **决策**：
  - 推荐接入 Cloudflare Images（可选）
  - MVP 阶段可直接存原图

---

## 5. 用户管理（已确认）

### 5.1 admin 表
- **决策**：复用 better-auth 的 user 表，通过 role 字段标识 admin

---

## 6. 文档要求

- **要求**：作为开源项目，需要有给人类读的、有品味的文档
- **包括**：
  - 如何开发（贡献者指南）
  - 如何部署使用（用户指南）

---

## 7. 内容与显示（已确认）

### 7.1 Markdown 渲染
- **决策**：`marked` + 按需添加扩展，保持轻量

### 7.2 Article 中嵌入图片
- **决策**：
  - 标准 Markdown 语法 `![alt](url)`
  - 编辑器支持直接粘贴图片（自动上传）
  - 编辑器提供插入按钮
  - 编辑器风格参考 Pika.page

### 7.3 URL 路径策略
- **决策**：
  - 字段名用 `path`（不是 slug），支持多级路径
  - 非 page 类型：默认 `/p/{sqid}`，可自定义 path，修改后旧路径自动 301 重定向
  - page 类型：用户必须填写 path

### 7.4 分页策略
- **决策**：
  - Cursor-based + 无限滚动
  - Archive 页面仿 Tumblr，按月份无限滚动
  - 默认每页 100 项（可配置）

### 7.5 FTS5 trigram
- **决策**：实现时验证 D1 是否支持，如不支持再调整

### 7.6 SEO 和社交分享
- **决策**：
  - og:image 用帖子第一张图，没有则不输出
  - 标题回退：取正文第一行或前 120 字（取最小）
  - 支持 JSON-LD 结构化数据
  - 支持 canonical URL

### 7.7 错误页面
- **决策**：
  - 保持品牌一致性
  - 不暴露代码错误细节，但已知错误可显示

### 7.8 时区处理
- **决策**：
  - 1 个月内：显示相对时间，hover 显示本地时区（JS）
  - 超过 1 个月：服务端渲染 UTC 日期

### 7.9 帖子编辑历史
- **决策**：MVP 只保存 `updated_at`，显示「已编辑」标记

### 7.10 发布时间
- **决策**：
  - `created_at`：系统自动记录真实创建时间
  - `published_at`：用户可编辑的展示时间（只允许过去时间，不做定时发布）

---

## 8. Feed 与 Sitemap（已确认）

### 8.1 RSS/Atom Feed
- **决策**：按标准实现，输出最近 N 篇公开帖子

### 8.2 Sitemap
- **决策**：自动生成，包含所有公开帖子和页面

---

## 9. 待确认问题 #done

### 9.1 Datastar 集成方式
- **问题**：Datastar 如何与 Hono/JSX 配合？
- **选项**：
  - A) 通过 CDN 引入，在 JSX 中使用 `data-*` 属性
  - B) 作为 npm 依赖，有专门的集成方式
- **建议**：A（更简单，符合 Hypermedia 理念）

请直接 download 到 aseets 或者 static 文件夹，然后引入即可。我不需要第三方 cdn，我自己托管。

### 9.2 BaseCoat 安装方式
- **问题**：BaseCoat 具体如何安装使用？
- **理解**：看起来是 Tailwind 插件，通过 `@plugin` 引入

这个你参考他们的文档来, 我帮你新建了一个 `references` 文件夹，有需要的话，你可以把第三方的库 git clone 下来，随时参考，我已经ignore这个目录了，不会提交上去。

### 9.3 Node 版本要求
- **问题**：项目要求的最低 Node 版本？
- **建议**：Node 24 LTS (>=24.0.0)

### 9.4 TypeScript 严格模式
- **问题**：是否启用 strict 模式？
- **建议**：是

是的。



